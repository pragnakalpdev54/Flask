
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://pragnakalpdev54.github.io/Flask/04_LEVEL_2A_INTERMEDIATE.html">
      
      
        <link rel="prev" href="03_TEST_TASK_1.html">
      
      
        <link rel="next" href="05_LEVEL_2B_INTERMEDIATE.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Level 2A ‚Äì Core Concepts - Flask Training Guide</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/footer.css">
    
      <link rel="stylesheet" href="assets/stylesheets/extra.css">
    
      <link rel="stylesheet" href="assets/stylesheets/sidebar.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#level-2a-intermediate-databases-the-service-layer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Flask Training Guide" class="md-header__button md-logo" aria-label="Flask Training Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Flask Training Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Level 2A ‚Äì Core Concepts
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Flask Training Guide" class="md-nav__button md-logo" aria-label="Flask Training Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Flask Training Guide
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="01_LEVEL_0_BEGINNER.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Level 0 ‚Äì Beginner
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="02_LEVEL_1_FOUNDATIONS.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Level 1 ‚Äì Foundations
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="03_TEST_TASK_1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Task 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Level 2A ‚Äì Core Concepts
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="04_LEVEL_2A_INTERMEDIATE.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Level 2A ‚Äì Core Concepts
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#goal" class="md-nav__link">
    <span class="md-ellipsis">
      
        Goal
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-flask-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setting Up Flask-SQLAlchemy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting Up Flask-SQLAlchemy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-extensionspy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why extensions.py?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        File Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-create-extensionspy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Create extensions.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-create-your-app-in-apppy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Create Your App in app.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-define-models-in-modelspy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: Define Models in models.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-critical-import-models-in-apppy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: CRITICAL - Import Models in app.py
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Defining Models
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defining Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-relationships" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model Relationships
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Model Relationships">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#one-to-many-relationship" class="md-nav__link">
    <span class="md-ellipsis">
      
        One-to-Many Relationship
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#database-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Database Migrations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why Migrations?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-migration-workflow-when-to-run-each-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Migration Workflow: When to Run Each Command
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Migration Workflow: When to Run Each Command">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-flask-db-init-initialize-migrations-once-per-project" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. flask db init - Initialize Migrations (ONCE per project)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-flask-db-migrate-generate-migration-script-when-models-change" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. flask db migrate - Generate Migration Script (When models change)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-flask-db-upgrade-apply-migration-after-migrate-or-when-deploying" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. flask db upgrade - Apply Migration (After migrate, or when deploying)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-example-adding-a-column" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete Example: Adding a Column
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Complete Example: Adding a Column">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-modify-your-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Modify your model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-generate-migration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Generate migration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-apply-migration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: Apply migration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-mistakes-juniors-make" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Mistakes Juniors Make
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sqlalchemy-fundamentals-crud-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        SQLAlchemy Fundamentals: CRUD Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SQLAlchemy Fundamentals: CRUD Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-database-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Database Session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-adding-new-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create: Adding New Records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-querying-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Read: Querying Data
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Read: Querying Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-all-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get All Records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-by-primary-key" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get by Primary Key
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Filter Records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#count-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Count Records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Order Results
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Limit Results
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-modifying-existing-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update: Modifying Existing Records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-removing-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Delete: Removing Records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-with-rollback" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling with Rollback
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-reference-sqlalchemy-crud" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quick Reference: SQLAlchemy CRUD
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-service-layer-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Service Layer Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Service Layer Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concept-classes-as-namespaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        üß† Concept: Classes as Namespaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-bad-way-fat-routes" class="md-nav__link">
    <span class="md-ellipsis">
      
        ‚ùå The Bad Way (Fat Routes)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-good-way-thin-routes-service-layer" class="md-nav__link">
    <span class="md-ellipsis">
      
        ‚úÖ The Good Way (Thin Routes + Service Layer)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="‚úÖ The Good Way (Thin Routes + Service Layer)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-1-class-based-service-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option 1: Class-Based Service (Recommended)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-2-function-based-service-also-acceptable" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option 2: Function-Based Service (Also Acceptable)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refactoring-the-right-way" class="md-nav__link">
    <span class="md-ellipsis">
      
        Refactoring: The Right Way
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Refactoring: The Right Way">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-by-step-refactoring-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step-by-Step Refactoring Process
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-refactoring-a-create-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example: Refactoring a Create Endpoint
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-refactoring-principles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Refactoring Principles
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice-problems" class="md-nav__link">
    <span class="md-ellipsis">
      
        Practice Problems
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice Problems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem-1-book-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem 1: Book Model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem 1: Book Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-the-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Create the Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-run-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Run Migrations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-2-book-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem 2: Book Service
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-3-refactor-calculator-to-use-service-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem 3: Refactor Calculator to Use Service Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem 3: Refactor Calculator to Use Service Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solution-1-class-based-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solution 1: Class-Based (Recommended)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution-2-function-based-also-acceptable" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solution 2: Function-Based (Also Acceptable)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls-quiz" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls Quiz
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Pitfalls Quiz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pitfall-1-forgetting-dbsessioncommit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pitfall 1: Forgetting db.session.commit()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfall-2-running-flask-db-init-multiple-times" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pitfall 2: Running flask db init Multiple Times
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfall-3-forgetting-to-import-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pitfall 3: Forgetting to Import Models
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfall-4-putting-database-logic-in-routes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pitfall 4: Putting Database Logic in Routes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfall-5-circular-import-hell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pitfall 5: Circular Import Hell
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trivia" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trivia
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trivia">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#question-1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Question 1
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#question-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Question 2
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#question-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Question 3
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="05_LEVEL_2B_INTERMEDIATE.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Level 2B ‚Äì Applied Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="06_LEVEL_3_AUTHENTICATION.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Level 3 ‚Äì Authentication & Security
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="07_TEST_TASK_2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Task 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="08_LEVEL_4_SCALABLE.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Level 4 ‚Äì Scalable Systems
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="10_TEST_TASK_3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Task 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ERROR_TRACKING.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Tracking
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="PATTERN_CHEATSHEET.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Reference Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="POSTMAN_GUIDE_PART1_BASICS.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Postman Basics
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="POSTMAN_GUIDE_PART2_ADVANCED.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Postman Advanced
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="CURL_GUIDE.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    cURL Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="level-2a-intermediate-databases-the-service-layer">Level 2A: Intermediate - Databases &amp; The Service Layer<a class="headerlink" href="#level-2a-intermediate-databases-the-service-layer" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>Prerequisites</strong>: <a href="03_TEST_TASK_1.html">Test Task 1</a>
<strong>Next Level</strong>: <a href="05_LEVEL_2B_INTERMEDIATE.html">Level 2B: Serialization</a></p>
<p>[!NOTE]
<strong>OOP Level</strong>: Low. We define classes for database models and services, but they are mostly <strong>configuration</strong> and <strong>namespaces for functions</strong>. You do <strong>not</strong> need to understand constructors, inheritance, or polymorphism to follow this level.</p>
</blockquote>
<h2 id="goal">Goal<a class="headerlink" href="#goal" title="Permanent link">&para;</a></h2>
<p>In this level, we connect our Flask application to a Relational Database using <strong>Flask-SQLAlchemy</strong>. Crucially, we will learn the <strong>Service Layer Pattern</strong> to keep our code clean, scalable, and professional.</p>
<p><strong>Strict Rules:</strong></p>
<ol>
<li><strong>Thin Routes</strong>: Routes never access the database directly.</li>
<li><strong>Service Layer</strong>: All business logic and DB calls reside in services.</li>
<li><strong>ORM Only</strong>: Use SQLAlchemy models, not raw SQL.</li>
</ol>
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#setting-up-flask-sqlalchemy">Setting Up Flask-SQLAlchemy</a></li>
<li><a href="#defining-models">Defining Models</a></li>
<li><a href="#database-migrations">Database Migrations</a></li>
<li><a href="#the-service-layer-pattern">The Service Layer Pattern</a></li>
<li><a href="#refactoring-the-right-way">Refactoring: The Right Way</a></li>
<li><a href="#practice-problems">Practice Problems</a></li>
</ol>
<h2 id="setting-up-flask-sqlalchemy">Setting Up Flask-SQLAlchemy<a class="headerlink" href="#setting-up-flask-sqlalchemy" title="Permanent link">&para;</a></h2>
<p>Install dependencies:</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>flask-sqlalchemy<span class="w"> </span>flask-migrate<span class="w"> </span>psycopg2-binary
</code></pre></div>

<blockquote>
<p>[!NOTE]
We use psycopg2 for PostgreSQL, but strict ORM usage means we can switch easily.</p>
</blockquote>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<h4 id="why-extensionspy">Why <code>extensions.py</code>?<a class="headerlink" href="#why-extensionspy" title="Permanent link">&para;</a></h4>
<p>In larger Flask applications, we create a separate <code>extensions.py</code> file to avoid <strong>circular import</strong> problems.</p>
<p><strong>The Problem:</strong></p>
<ul>
<li><code>app.py</code> needs to import models to register routes</li>
<li><code>models.py</code> needs <code>db</code> to define tables</li>
<li>If both files import from each other ‚Üí <strong>CircularImportError</strong></li>
</ul>
<p><strong>The Solution:</strong></p>
<ul>
<li>Create <code>extensions.py</code> to hold <code>db</code> and <code>migrate</code></li>
<li>Both <code>app.py</code> and <code>models.py</code> import from <code>extensions.py</code></li>
<li>No circular dependency!</li>
</ul>
<blockquote>
<p>[!NOTE]
For tiny projects, you <em>could</em> put everything in <code>app.py</code>. But learning the <code>extensions.py</code> pattern now will save you pain later.</p>
</blockquote>
<h4 id="file-structure">File Structure<a class="headerlink" href="#file-structure" title="Permanent link">&para;</a></h4>
<p>Here's how to organize your Flask project:</p>
<div class="codehilite"><pre><span></span><code>my_flask_project/
‚îú‚îÄ‚îÄ app.py              # Application factory and routes
‚îú‚îÄ‚îÄ extensions.py       # Database and migration objects
‚îú‚îÄ‚îÄ models.py           # Database models
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ migrations/         # Created after &#39;flask db init&#39;
</code></pre></div>

<h4 id="step-1-create-extensionspy">Step 1: Create <code>extensions.py</code><a class="headerlink" href="#step-1-create-extensionspy" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># extensions.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_migrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">Migrate</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>
</code></pre></div>

<p>This file just creates the "magic boxes" - they're not connected to any app yet.</p>
<h4 id="step-2-create-your-app-in-apppy">Step 2: Create Your App in <code>app.py</code><a class="headerlink" href="#step-2-create-your-app-in-apppy" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">migrate</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># Configure your DB URI</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///app.db&#39;</span>  <span class="c1"># or postgresql://...</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Recommended</span>

    <span class="c1"># Initialize extensions with app</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h4 id="step-3-define-models-in-modelspy">Step 3: Define Models in <code>models.py</code><a class="headerlink" href="#step-3-define-models-in-modelspy" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>  <span class="c1"># Import db from extensions, not app!</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<h4 id="step-4-critical-import-models-in-apppy">Step 4: <strong>CRITICAL</strong> - Import Models in <code>app.py</code><a class="headerlink" href="#step-4-critical-import-models-in-apppy" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!WARNING]
Flask-Migrate will <strong>NOT</strong> detect your models unless you import them!</p>
</blockquote>
<p>Update your <code>app.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">migrate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>  <span class="c1"># Import models so migrations detect them</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///app.db&#39;</span>

    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>

<p><strong>Why import inside the function?</strong> To avoid circular imports. By importing inside <code>create_app()</code>, both files can safely import from <code>extensions.py</code> first.</p>
<blockquote>
<p>[!TIP]
<strong>Magic Box ‚Äì <code>db</code> and <code>migrate</code></strong>: <code>db = SQLAlchemy()</code> and <code>migrate = Migrate()</code> create Magic Boxes that handle the low-level database work and migrations for you. You mainly need to import them from <code>extensions.py</code> and run <code>flask db migrate</code> / <code>flask db upgrade</code> when models change.</p>
</blockquote>
<h2 id="defining-models">Defining Models<a class="headerlink" href="#defining-models" title="Permanent link">&para;</a></h2>
<p>Models are Python classes that map to database tables.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;User </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
</code></pre></div>

<h3 id="model-relationships">Model Relationships<a class="headerlink" href="#model-relationships" title="Permanent link">&para;</a></h3>
<p>When your data is related (like Authors and their Books), you need to define relationships.</p>
<h4 id="one-to-many-relationship">One-to-Many Relationship<a class="headerlink" href="#one-to-many-relationship" title="Permanent link">&para;</a></h4>
<p><strong>Example</strong>: One Author can have multiple Books. One Book belongs to one Author.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Author</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;authors&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">bio</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>

    <span class="c1"># One-to-Many: One author has many books</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Book&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all, delete-orphan&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;books&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Foreign Key: Links to Author table</span>
    <span class="n">author_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;authors.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<p><strong>Key parts explained:</strong></p>
<ol>
<li><strong><code>db.ForeignKey('authors.id')</code></strong>: Creates a link to the <code>authors</code> table's <code>id</code> column</li>
<li><strong><code>db.relationship('Book', ...)</code></strong>: Tells SQLAlchemy how models are connected</li>
<li><strong><code>backref='author'</code></strong>: Automatically creates <code>book.author</code> to access the author from a book</li>
<li><strong><code>cascade='all, delete-orphan'</code></strong>: When you delete an author, all their books are deleted too</li>
</ol>
<p><strong>Using relationships in code:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create an author</span>
<span class="n">author</span> <span class="o">=</span> <span class="n">Author</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;J.K. Rowling&quot;</span><span class="p">,</span> <span class="n">bio</span><span class="o">=</span><span class="s2">&quot;British author&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># Create books for that author</span>
<span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Harry Potter&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">19.99</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">book2</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Fantastic Beasts&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">15.99</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">book1</span><span class="p">,</span> <span class="n">book2</span><span class="p">])</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># Access author&#39;s books</span>
<span class="nb">print</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">books</span><span class="p">)</span>  <span class="c1"># [&lt;Book Harry Potter&gt;, &lt;Book Fantastic Beasts&gt;]</span>

<span class="c1"># Access book&#39;s author (thanks to backref)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">book1</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>  <span class="c1"># &lt;Author J.K. Rowling&gt;</span>

<span class="c1"># Cascade delete: Delete author deletes all their books</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="c1"># Both books are automatically deleted!</span>
</code></pre></div>

<p><strong>Common cascade options:</strong></p>
<ul>
<li><code>'all, delete-orphan'</code>: Delete children when parent is deleted (most common)</li>
<li><code>'all'</code>: All operations cascade, but orphans remain</li>
<li><code>None</code>: No cascading (default)</li>
</ul>
<blockquote>
<p>[!NOTE]
<strong>For Test Task 2</strong>: You'll need to use exactly this pattern for Authors and Books with cascade delete!</p>
</blockquote>
<h2 id="database-migrations">Database Migrations<a class="headerlink" href="#database-migrations" title="Permanent link">&para;</a></h2>
<h3 id="why-migrations">Why Migrations?<a class="headerlink" href="#why-migrations" title="Permanent link">&para;</a></h3>
<p>Imagine you have a running website with 10,000 users in your database. You realize you need to add a <code>phone_number</code> column to the <code>users</code> table.</p>
<p><strong>Bad approach (loses all data):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Delete the database and recreate it</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;app.db&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>  <span class="c1"># All 10,000 users are gone!</span>
</code></pre></div>

<p><strong>Good approach (with migrations):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Add column to model, then run:</span>
flask<span class="w"> </span>db<span class="w"> </span>migrate<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add phone number to users&quot;</span>
flask<span class="w"> </span>db<span class="w"> </span>upgrade
<span class="c1"># All 10,000 users are still there, just with a new NULL phone_number column</span>
</code></pre></div>

<p><strong>Migrations</strong> allow you to evolve your database schema over time without losing data. <strong>Alembic</strong> (handled by Flask-Migrate) generates the SQL commands needed to transform your database from one state to another.</p>
<h3 id="the-migration-workflow-when-to-run-each-command">The Migration Workflow: When to Run Each Command<a class="headerlink" href="#the-migration-workflow-when-to-run-each-command" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!IMPORTANT]
<strong>You do NOT need to run all 3 commands every time!</strong> Here's when to use each:</p>
</blockquote>
<h4 id="1-flask-db-init-initialize-migrations-once-per-project">1. <code>flask db init</code> - Initialize Migrations (ONCE per project)<a class="headerlink" href="#1-flask-db-init-initialize-migrations-once-per-project" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>flask<span class="w"> </span>db<span class="w"> </span>init
</code></pre></div>

<p><strong>When to run:</strong> Only <strong>once</strong> when you're setting up migrations for the first time in a project.</p>
<p><strong>What it does:</strong> Creates a <code>migrations/</code> folder with Alembic configuration.</p>
<p><strong>You've already run this if:</strong> You see a <code>migrations/</code> directory in your project.</p>
<blockquote>
<p>[!WARNING]
<strong>Do NOT run <code>flask db init</code> multiple times!</strong> If you do, delete the <code>migrations/</code> folder first.</p>
</blockquote>
<h4 id="2-flask-db-migrate-generate-migration-script-when-models-change">2. <code>flask db migrate</code> - Generate Migration Script (When models change)<a class="headerlink" href="#2-flask-db-migrate-generate-migration-script-when-models-change" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>flask<span class="w"> </span>db<span class="w"> </span>migrate<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Descriptive message about the change&quot;</span>
</code></pre></div>

<p><strong>When to run:</strong> <strong>Every time you modify a model</strong> (add/remove columns, add new models, etc.).</p>
<p><strong>What it does:</strong></p>
<ul>
<li>Compares your Python models to the current database schema</li>
<li>Generates a Python migration file in <code>migrations/versions/</code></li>
<li><strong>Does NOT</strong> change your database yet!</li>
</ul>
<p><strong>Example scenarios:</strong></p>
<ul>
<li>Added a new column: <code>flask db migrate -m "Add phone to user"</code></li>
<li>Created a new model: <code>flask db migrate -m "Add Product model"</code></li>
<li>Removed a column: <code>flask db migrate -m "Remove deprecated status field"</code></li>
</ul>
<p><strong>Important:</strong> Always review the generated file before running <code>upgrade</code>!</p>
<h4 id="3-flask-db-upgrade-apply-migration-after-migrate-or-when-deploying">3. <code>flask db upgrade</code> - Apply Migration (After migrate, or when deploying)<a class="headerlink" href="#3-flask-db-upgrade-apply-migration-after-migrate-or-when-deploying" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>flask<span class="w"> </span>db<span class="w"> </span>upgrade
</code></pre></div>

<p><strong>When to run:</strong></p>
<ul>
<li><strong>After</strong> running <code>flask db migrate</code> to apply your changes locally</li>
<li><strong>When deploying</strong> to production/staging (to update their databases)</li>
<li><strong>After pulling</strong> code from teammates who added migrations</li>
</ul>
<p><strong>What it does:</strong> Executes the migration scripts and actually modifies your database.</p>
<h3 id="complete-example-adding-a-column">Complete Example: Adding a Column<a class="headerlink" href="#complete-example-adding-a-column" title="Permanent link">&para;</a></h3>
<p>Let's say you want to add a <code>phone_number</code> field to your User model.</p>
<h4 id="step-1-modify-your-model">Step 1: Modify your model<a class="headerlink" href="#step-1-modify-your-model" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># models.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>  <span class="c1"># New field!</span>
</code></pre></div>

<h4 id="step-2-generate-migration">Step 2: Generate migration<a class="headerlink" href="#step-2-generate-migration" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>flask<span class="w"> </span>db<span class="w"> </span>migrate<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add phone number to users&quot;</span>
</code></pre></div>

<p>Output:</p>
<div class="codehilite"><pre><span></span><code>INFO  [alembic.autogenerate.compare] Detected added column &#39;users.phone_number&#39;
Generating /path/to/migrations/versions/abc123_add_phone_number_to_users.py ... done
</code></pre></div>

<h4 id="step-3-apply-migration">Step 3: Apply migration<a class="headerlink" href="#step-3-apply-migration" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>flask<span class="w"> </span>db<span class="w"> </span>upgrade
</code></pre></div>

<p>Output:</p>
<div class="codehilite"><pre><span></span><code><span class="n">INFO</span><span class="w">  </span><span class="p">[</span><span class="n">alembic</span><span class="p">.</span><span class="n">runtime</span><span class="p">.</span><span class="n">migration</span><span class="p">]</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="n">upgrade</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">abc123</span><span class="p">,</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">phone</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">users</span>
</code></pre></div>

<p>Done! Your database now has the <code>phone_number</code> column.</p>
<h3 id="common-mistakes-juniors-make">Common Mistakes Juniors Make<a class="headerlink" href="#common-mistakes-juniors-make" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>‚ùå Running all 3 commands every time</strong></li>
</ol>
<p><code>bash
   # WRONG - Don't do this!
   flask db init    # Only run once ever
   flask db migrate
   flask db upgrade</code></p>
<ol>
<li><strong>‚ùå Forgetting to import models in app.py</strong></li>
</ol>
<p>Result: <code>flask db migrate</code> says "No changes detected" even though you modified models.</p>
<p>Fix: Make sure you imported your models in <code>app.py</code> as shown in the Configuration section.</p>
<ol>
<li><strong>‚ùå Running <code>upgrade</code> without <code>migrate</code> first</strong></li>
</ol>
<p>Result: No new migration file, so <code>upgrade</code> does nothing.</p>
<h3 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> "No changes detected" even though I modified my model.</p>
<p><strong>Solutions:</strong></p>
<ul>
<li>Did you import the model in <code>app.py</code>?</li>
<li>Did you save the <code>models.py</code> file?</li>
<li>Try: <code>flask db migrate -m "Force migration" --autogenerate</code></li>
</ul>
<p><strong>Problem:</strong> "Can't locate revision identified by 'xyz'"</p>
<p><strong>Solution:</strong> Your <code>migrations/</code> folder is out of sync. In development, you can:</p>
<ol>
<li>Delete <code>migrations/</code> folder</li>
<li>Delete <code>app.db</code></li>
<li>Run <code>flask db init</code>, then <code>flask db migrate</code>, then <code>flask db upgrade</code></li>
</ol>
<h2 id="sqlalchemy-fundamentals-crud-operations">SQLAlchemy Fundamentals: CRUD Operations<a class="headerlink" href="#sqlalchemy-fundamentals-crud-operations" title="Permanent link">&para;</a></h2>
<p>Before we jump into Services, you need to know how to actually <strong>use</strong> SQLAlchemy to work with data. This section teaches you the basics.</p>
<h3 id="the-database-session">The Database Session<a class="headerlink" href="#the-database-session" title="Permanent link">&para;</a></h3>
<p>SQLAlchemy uses a <strong>session</strong> (<code>db.session</code>) to manage database operations. Think of it like a shopping cart:</p>
<ul>
<li>You add items (records) to the cart (<code>db.session.add()</code>)</li>
<li>When ready, you checkout (<code>db.session.commit()</code>)</li>
<li>If you change your mind, you can empty the cart (<code>db.session.rollback()</code>)</li>
</ul>
<h3 id="create-adding-new-records">Create: Adding New Records<a class="headerlink" href="#create-adding-new-records" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="c1"># Create a new user object</span>
<span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
    <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
    <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">,</span>
    <span class="n">password_hash</span><span class="o">=</span><span class="s2">&quot;hashed_password_here&quot;</span>
<span class="p">)</span>

<span class="c1"># Add to session (not saved yet!)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>

<span class="c1"># Commit to database (now it&#39;s saved)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># After commit, the user object gets its ID from the database</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>  <span class="c1"># e.g., 1</span>
</code></pre></div>

<p><strong>Adding multiple records:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">users</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;bob@example.com&quot;</span><span class="p">,</span> <span class="n">password_hash</span><span class="o">=</span><span class="s2">&quot;hash1&quot;</span><span class="p">),</span>
    <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;charlie&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;charlie@example.com&quot;</span><span class="p">,</span> <span class="n">password_hash</span><span class="o">=</span><span class="s2">&quot;hash2&quot;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<h3 id="read-querying-data">Read: Querying Data<a class="headerlink" href="#read-querying-data" title="Permanent link">&para;</a></h3>
<p>SQLAlchemy provides a powerful query API. Here are the essentials:</p>
<h4 id="get-all-records">Get All Records<a class="headerlink" href="#get-all-records" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Get all users</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</code></pre></div>

<h4 id="get-by-primary-key">Get by Primary Key<a class="headerlink" href="#get-by-primary-key" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Get user with ID = 1</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="n">user</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;User not found&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Or safer with <code>get_or_404</code> (if using in routes):</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">abort</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Auto-returns 404 if not found</span>
</code></pre></div>

<h4 id="filter-records">Filter Records<a class="headerlink" href="#filter-records" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Get all users with a specific username</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># Get first user matching condition</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No user found&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Multiple conditions:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Find active users named Alice</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p><strong>Complex filters:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Using filter() for more complex conditions</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1">lice%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># Multiple conditions with filter()</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">User</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">User</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;@example.com&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<h4 id="count-records">Count Records<a class="headerlink" href="#count-records" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">total_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">active_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</code></pre></div>

<h4 id="order-results">Order Results<a class="headerlink" href="#order-results" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Order by username ascending</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># Order by ID descending</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<h4 id="limit-results">Limit Results<a class="headerlink" href="#limit-results" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Get first 10 users</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># Skip first 20, then get next 10 (pagination)</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<h3 id="update-modifying-existing-records">Update: Modifying Existing Records<a class="headerlink" href="#update-modifying-existing-records" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Get the user</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">user</span><span class="p">:</span>
    <span class="c1"># Modify attributes</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;newemail@example.com&quot;</span>
    <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Commit changes</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<p><strong>Bulk update:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Update all inactive users to active</span>
<span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<h3 id="delete-removing-records">Delete: Removing Records<a class="headerlink" href="#delete-removing-records" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Get the user</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">user</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<p><strong>Bulk delete:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Delete all inactive users</span>
<span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<h3 id="error-handling-with-rollback">Error Handling with Rollback<a class="headerlink" href="#error-handling-with-rollback" title="Permanent link">&para;</a></h3>
<p>If something goes wrong, you can rollback the session:</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># Undo all changes</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="quick-reference-sqlalchemy-crud">Quick Reference: SQLAlchemy CRUD<a class="headerlink" href="#quick-reference-sqlalchemy-crud" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Code Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Create</strong></td>
<td><code>db.session.add(obj)</code> + <code>db.session.commit()</code></td>
</tr>
<tr>
<td><strong>Read All</strong></td>
<td><code>Model.query.all()</code></td>
</tr>
<tr>
<td><strong>Read One</strong></td>
<td><code>Model.query.get(id)</code> or <code>.first()</code></td>
</tr>
<tr>
<td><strong>Filter</strong></td>
<td><code>Model.query.filter_by(field=value).all()</code></td>
</tr>
<tr>
<td><strong>Update</strong></td>
<td><code>obj.field = new_value</code> + <code>db.session.commit()</code></td>
</tr>
<tr>
<td><strong>Delete</strong></td>
<td><code>db.session.delete(obj)</code> + <code>db.session.commit()</code></td>
</tr>
<tr>
<td><strong>Rollback</strong></td>
<td><code>db.session.rollback()</code></td>
</tr>
</tbody>
</table>
<h2 id="the-service-layer-pattern">The Service Layer Pattern<a class="headerlink" href="#the-service-layer-pattern" title="Permanent link">&para;</a></h2>
<p>This is the most important architectural rule in our project.</p>
<h3 id="concept-classes-as-namespaces">üß† Concept: Classes as Namespaces<a class="headerlink" href="#concept-classes-as-namespaces" title="Permanent link">&para;</a></h3>
<p>We use <code>class UserService</code>. <strong>Don't panic.</strong> We are not creating objects (<code>user_service = UserService()</code>).</p>
<p>We are just using the class as a <strong>Namespace</strong> (like a folder) to group related functions together.</p>
<ul>
<li><code>UserService.create_user()</code></li>
<li><code>UserService.get_all_users()</code></li>
</ul>
<p>It keeps our code organized. Pure functions would work too, but this is the Flask/Python industry standard.</p>
<p>You can think of it as two equivalent styles:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Pure functions (no classes)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">():</span>
    <span class="o">...</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># Same idea, grouped in a class-as-namespace</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">():</span>
        <span class="o">...</span>
</code></pre></div>

<p>In this course we mostly use the <strong>second style</strong> because it scales better in real projects, but you do <strong>not</strong> need to learn constructors, inheritance, or polymorphism. If you ever feel stuck, revisit the OOP FAQ in the main <strong>Flask Learning Guide</strong> and remember that classes here are just organized folders for related functions.</p>
<blockquote>
<p>[!TIP]
If you see confusing errors around <code>self</code> or class methods, double-check that your service methods are marked with <code>@staticmethod</code> and that you are calling them like <code>UserService.create_user(...)</code> (without creating an instance).</p>
</blockquote>
<h3 id="the-bad-way-fat-routes">‚ùå The Bad Way (Fat Routes)<a class="headerlink" href="#the-bad-way-fat-routes" title="Permanent link">&para;</a></h3>
<p><strong>Do NOT do this:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># BAD CODE - DO NOT USE</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="c1"># Business logic in route!</span>
    <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email exists&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># DB access in route!</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">new_user</span><span class="o">.</span><span class="n">id</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<h3 id="the-good-way-thin-routes-service-layer">‚úÖ The Good Way (Thin Routes + Service Layer)<a class="headerlink" href="#the-good-way-thin-routes-service-layer" title="Permanent link">&para;</a></h3>
<p>You can implement the Service Layer using either <strong>classes</strong> or <strong>functions</strong>. Both are correct!</p>
<h4 id="option-1-class-based-service-recommended">Option 1: Class-Based Service (Recommended)<a class="headerlink" href="#option-1-class-based-service-recommended" title="Permanent link">&para;</a></h4>
<p><strong>1. Create the Service (<code>services/user_service.py</code>)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles business logic for creating a user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validation Logic</span>
        <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Email already exists&quot;</span>

        <span class="c1"># DB Logic</span>
        <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password_hash</span><span class="o">=</span><span class="n">password_hash</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">new_user</span><span class="p">,</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p><strong>2. Call it from the Route (<code>app.py</code>)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">services.user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># ... app configuration ...</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># Route just delegates to Service</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="n">password_hash</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>  <span class="c1"># In real app, hash this first!</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Created&quot;</span><span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_users</span><span class="p">():</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">get_all_users</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">}</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]}),</span> <span class="mi">200</span>
</code></pre></div>

<h4 id="option-2-function-based-service-also-acceptable">Option 2: Function-Based Service (Also Acceptable)<a class="headerlink" href="#option-2-function-based-service-also-acceptable" title="Permanent link">&para;</a></h4>
<p>If you're not comfortable with classes, you can use plain functions:</p>
<p><strong>1. Create Service Functions (<code>services/user_functions.py</code>)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles business logic for creating a user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validation Logic</span>
    <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Email already exists&quot;</span>

    <span class="c1"># DB Logic</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password_hash</span><span class="o">=</span><span class="n">password_hash</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">new_user</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p><strong>2. Call it from the Route (<code>app.py</code>)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">services.user_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_user</span><span class="p">,</span> <span class="n">get_all_users</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># ... app configuration ...</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user_endpoint</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># Route just delegates to service function</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="n">password_hash</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Created&quot;</span><span class="p">}),</span> <span class="mi">201</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_users_endpoint</span><span class="p">():</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">get_all_users</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">}</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]}),</span> <span class="mi">200</span>
</code></pre></div>

<blockquote>
<p>[!NOTE]
Both approaches achieve the same goal! The class-based approach is industry standard for larger projects, but function-based works perfectly. Choose what you're comfortable with.</p>
</blockquote>
<h3 id="why">Why?<a class="headerlink" href="#why" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Reusability</strong>: You can call <code>UserService.create_user</code> from a CLI command or a test or another service.</li>
<li><strong>Testing</strong>: You can test <code>UserService</code> without faking HTTP requests.</li>
<li><strong>Maintainability</strong>: Routes stay simple and clean.</li>
</ol>
<h2 id="refactoring-the-right-way">Refactoring: The Right Way<a class="headerlink" href="#refactoring-the-right-way" title="Permanent link">&para;</a></h2>
<p>When you have existing code with fat routes (business logic and database calls in routes), here's how to refactor it properly:</p>
<h3 id="step-by-step-refactoring-process">Step-by-Step Refactoring Process<a class="headerlink" href="#step-by-step-refactoring-process" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Identify the Logic</strong>: Find all business logic and database operations in your routes</li>
<li><strong>Extract to Service</strong>: Move that logic to a service method</li>
<li><strong>Update Route</strong>: Make the route call the service method</li>
<li><strong>Test</strong>: Verify the behavior remains the same</li>
</ol>
<h3 id="example-refactoring-a-create-endpoint">Example: Refactoring a Create Endpoint<a class="headerlink" href="#example-refactoring-a-create-endpoint" title="Permanent link">&para;</a></h3>
<p><strong>Before (Fat Route):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="c1"># Validation in route</span>
    <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email exists&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    <span class="c1"># DB logic in route</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">new_user</span><span class="o">.</span><span class="n">id</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<p><strong>After (Thin Route + Service):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># In services/user_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Email already exists&quot;</span>
        <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_user</span><span class="p">,</span> <span class="kc">None</span>

<span class="c1"># In app.py</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}),</span> <span class="mi">400</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<h3 id="key-refactoring-principles">Key Refactoring Principles<a class="headerlink" href="#key-refactoring-principles" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>One Step at a Time</strong>: Refactor one route at a time, test, then move to the next</li>
<li><strong>Preserve Behavior</strong>: The API should work exactly the same after refactoring</li>
<li><strong>Keep It Simple</strong>: Don't over-engineer - extract logic, don't add complexity</li>
</ul>
<h2 id="practice-problems">Practice Problems<a class="headerlink" href="#practice-problems" title="Permanent link">&para;</a></h2>
<h3 id="problem-1-book-model">Problem 1: Book Model<a class="headerlink" href="#problem-1-book-model" title="Permanent link">&para;</a></h3>
<p>Create a <code>Book</code> model with the following fields:</p>
<ul>
<li><code>title</code> (String, required)</li>
<li><code>author</code> (String, required)</li>
<li><code>isbn</code> (String, unique)</li>
</ul>
<h4 id="step-1-create-the-model">Step 1: Create the Model<a class="headerlink" href="#step-1-create-the-model" title="Permanent link">&para;</a></h4>
<p>Create <code>models.py</code> (or add to existing):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;books&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">isbn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<h4 id="step-2-run-migrations">Step 2: Run Migrations<a class="headerlink" href="#step-2-run-migrations" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>flask<span class="w"> </span>db<span class="w"> </span>migrate<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add Book model&quot;</span>
flask<span class="w"> </span>db<span class="w"> </span>upgrade
</code></pre></div>

<p>Verify the migration was created and the table exists.</p>
<h3 id="problem-2-book-service">Problem 2: Book Service<a class="headerlink" href="#problem-2-book-service" title="Permanent link">&para;</a></h3>
<p>Create a <code>BookService</code> with methods:</p>
<ul>
<li><code>add_book(title, author, isbn)</code></li>
<li><code>get_books_by_author(author)</code></li>
</ul>
<p>Ensure <code>add_book</code> raises an error if ISBN already exists.</p>
<p><strong>Starter code</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># services/book_service.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Book</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookService</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_book</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">isbn</span><span class="p">):</span>
        <span class="c1"># Check if ISBN exists</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">isbn</span><span class="o">=</span><span class="n">isbn</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Book with this ISBN already exists&quot;</span>

        <span class="c1"># Create book</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="n">isbn</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="c1"># Hint: Something is missing here...</span>

        <span class="k">return</span> <span class="n">book</span><span class="p">,</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_books_by_author</span><span class="p">(</span><span class="n">author</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<h3 id="problem-3-refactor-calculator-to-use-service-pattern">Problem 3: Refactor Calculator to Use Service Pattern<a class="headerlink" href="#problem-3-refactor-calculator-to-use-service-pattern" title="Permanent link">&para;</a></h3>
<p>In Level 1, you built a <code>/calculate</code> endpoint that performed operations directly in the route. Now, refactor it to use the <strong>Service Layer Pattern</strong>.</p>
<p><strong>What is "CalculationService"?</strong></p>
<p>A <code>CalculationService</code> is simply a place to put your calculator logic (add, subtract, multiply, divide) <strong>outside</strong> of the route function. The route should only:</p>
<ol>
<li>Get the request data</li>
<li>Call the service</li>
<li>Return the response</li>
</ol>
<p>The service does the actual calculation.</p>
<p><strong>Why do this?</strong></p>
<ul>
<li><strong>Testable</strong>: You can test calculations without making HTTP requests</li>
<li><strong>Reusable</strong>: Other parts of your app can use the same calculation functions</li>
<li><strong>Clean</strong>: Routes stay simple and focused on HTTP handling</li>
</ul>
<h4 id="solution-1-class-based-recommended">Solution 1: Class-Based (Recommended)<a class="headerlink" href="#solution-1-class-based-recommended" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># services/calculation_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CalculationService</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a calculation based on the operation.</span>
<span class="sd">        Raises ValueError if operation is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;subtract&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;multiply&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;divide&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot divide by zero&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid operation: </span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># app.py or routes/calculator_routes.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">services.calculation_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalculationService</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/calculate&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># Validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Request body required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">operation</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">operation</span><span class="p">,</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing operation, x, or y&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Call the service</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">CalculationService</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}),</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>
</code></pre></div>

<h4 id="solution-2-function-based-also-acceptable">Solution 2: Function-Based (Also Acceptable)<a class="headerlink" href="#solution-2-function-based-also-acceptable" title="Permanent link">&para;</a></h4>
<p>If you're not comfortable with classes yet, you can use plain functions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># services/calculation_functions.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a calculation based on the operation.</span>
<span class="sd">    Raises ValueError if operation is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;subtract&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;multiply&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;divide&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot divide by zero&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid operation: </span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># app.py or routes/calculator_routes.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">services.calculation_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/calculate&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_endpoint</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Request body required&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">operation</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">operation</span><span class="p">,</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing operation, x, or y&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">calculate</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}),</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>
</code></pre></div>

<blockquote>
<p>[!NOTE]
Both solutions are correct! The class-based approach is the industry standard for larger projects, but the function-based approach works perfectly fine. Choose whichever you're more comfortable with.</p>
</blockquote>
<h2 id="common-pitfalls-quiz">Common Pitfalls Quiz<a class="headerlink" href="#common-pitfalls-quiz" title="Permanent link">&para;</a></h2>
<p>Test your understanding of database and architecture mistakes:</p>
<h3 id="pitfall-1-forgetting-dbsessioncommit">Pitfall 1: Forgetting db.session.commit()<a class="headerlink" href="#pitfall-1-forgetting-dbsessioncommit" title="Permanent link">&para;</a></h3>
<p><strong>Question</strong>: Why doesn't the user get created?</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Missing commit!</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Created&quot;</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<details>
<summary>Click to see answer</summary>

**Answer**: Changes are only written to the database when you call `db.session.commit()`. Without it, changes stay in memory and are lost.

**Fix**:


<div class="codehilite"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Actually save to database!</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Created&quot;</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>



**Remember**: SQLAlchemy uses a "Unit of Work" pattern:

1. `db.session.add()` - Stage changes
2. `db.session.commit()` - Write to database

</details>

<h3 id="pitfall-2-running-flask-db-init-multiple-times">Pitfall 2: Running flask db init Multiple Times<a class="headerlink" href="#pitfall-2-running-flask-db-init-multiple-times" title="Permanent link">&para;</a></h3>
<p><strong>Question</strong>: What happens?</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>flask<span class="w"> </span>db<span class="w"> </span>init
<span class="c1"># Creates migrations/ folder</span>
$<span class="w"> </span>flask<span class="w"> </span>db<span class="w"> </span>init<span class="w">  </span><span class="c1"># Run again by mistake</span>
Error:<span class="w"> </span>Directory<span class="w"> </span>migrations<span class="w"> </span>already<span class="w"> </span>exists
</code></pre></div>

<details>
<summary>Click to see answer</summary>

**Answer**: `flask db init` should only be run **ONCE** per project. It creates the `migrations/` folder structure.

**If you need to start fresh**:


<div class="codehilite"><pre><span></span><code><span class="c1"># Delete everything and start over (DEVELOPMENT ONLY!)</span>
rm<span class="w"> </span>-rf<span class="w"> </span>migrations/
rm<span class="w"> </span>app.db
flask<span class="w"> </span>db<span class="w"> </span>init
flask<span class="w"> </span>db<span class="w"> </span>migrate<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Initial migration&quot;</span>
flask<span class="w"> </span>db<span class="w"> </span>upgrade
</code></pre></div>



**Remember**:

- `flask db init` - Once per project
- `flask db migrate` - Every time models change
- `flask db upgrade` - After migrate, and when deploying

</details>

<h3 id="pitfall-3-forgetting-to-import-models">Pitfall 3: Forgetting to Import Models<a class="headerlink" href="#pitfall-3-forgetting-to-import-models" title="Permanent link">&para;</a></h3>
<p><strong>Question</strong>: Why does <code>flask db migrate</code> say "No changes detected"?</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">migrate</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
    <span class="c1"># Forgot to import models!</span>
    <span class="k">return</span> <span class="n">app</span>

<span class="c1"># models.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">))</span>
</code></pre></div>

<details>
<summary>Click to see answer</summary>

**Answer**: Flask-Migrate can't detect models you haven't imported! If Python doesn't load the model class, Alembic doesn't know it exists.

**Fix**:


<div class="codehilite"><pre><span></span><code><span class="c1"># app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">migrate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>  <span class="c1"># Import all models!</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>



</details>

<h3 id="pitfall-4-putting-database-logic-in-routes">Pitfall 4: Putting Database Logic in Routes<a class="headerlink" href="#pitfall-4-putting-database-logic-in-routes" title="Permanent link">&para;</a></h3>
<p><strong>Question</strong>: What's wrong with this architecture?</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># Business logic in route!</span>
    <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email exists&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Database calls in route!</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<details>
<summary>Click to see answer</summary>

**Answer**: **FAT ROUTES ARE BAD!** This violates the Service Layer pattern. Routes should only handle HTTP, not business logic or database calls.

**Fix with Service Layer**:


<div class="codehilite"><pre><span></span><code><span class="c1"># services/user_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Email exists&quot;</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span>

<span class="c1"># app.py</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}),</span> <span class="mi">400</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>



</details>

<h3 id="pitfall-5-circular-import-hell">Pitfall 5: Circular Import Hell<a class="headerlink" href="#pitfall-5-circular-import-hell" title="Permanent link">&para;</a></h3>
<p><strong>Question</strong>: Why does this crash with ImportError?</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1"># models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>  <span class="c1"># Circular import!</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<details>
<summary>Click to see answer</summary>

**Answer**: Circular import! `app.py` imports `models.py`, and `models.py` tries to import `app.py`.

**Fix with extensions.py**:


<div class="codehilite"><pre><span></span><code><span class="c1"># extensions.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>

<span class="c1"># models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>  <span class="c1"># Import from extensions!</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>



</details>

<h2 id="trivia">Trivia<a class="headerlink" href="#trivia" title="Permanent link">&para;</a></h2>
<h3 id="question-1">Question 1<a class="headerlink" href="#question-1" title="Permanent link">&para;</a></h3>
<p><strong>Where should database queries reside?</strong></p>
<ul>
<li>[ ] In the Route function</li>
<li>[ ] In the Template</li>
<li>[x] In the Service Layer</li>
<li>[ ] In the <code>app.py</code></li>
</ul>
<h3 id="question-2">Question 2<a class="headerlink" href="#question-2" title="Permanent link">&para;</a></h3>
<p><strong>What command applies changes to the database?</strong></p>
<ul>
<li>[ ] <code>flask db init</code></li>
<li>[ ] <code>flask db migrate</code></li>
<li>[x] <code>flask db upgrade</code></li>
<li>[ ] <code>flask run</code></li>
</ul>
<h3 id="question-3">Question 3<a class="headerlink" href="#question-3" title="Permanent link">&para;</a></h3>
<p><strong>Why do we avoid "Fat Routes"?</strong></p>
<ul>
<li>[ ] They take up too much disk space</li>
<li>[x] They mix business logic with HTTP logic, making code hard to test and reuse</li>
<li>[ ] Flask forbids them</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        


<nav class="md-footer__nav md-grid pill-navigation" aria-label="Footer navigation">
  
  
  <a href="03_TEST_TASK_1.html"
     class="pill-btn pill-prev"
     aria-label="Previous page">
    <span class="pill-arrow">‚Äπ</span>
    <span class="pill-text">PREVIOUS</span>
  </a>
  

  
  <a href="05_LEVEL_2B_INTERMEDIATE.html"
     class="pill-btn pill-next"
     aria-label="Next page">
    <span class="pill-text">NEXT</span>
    <span class="pill-arrow">‚Ä∫</span>
  </a>
  

</nav>




<footer class="md-footer">
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner footer-custom">

      <!-- Left -->
      <div class="footer-col footer-left">
        <strong>Flask Training Guide</strong>
      </div>

      <!-- Center -->
      <div class="footer-col footer-center">
        <p>¬© 2026 Pragnakalp Techlabs</p>
      </div>

      <!-- Right -->
      <div class="footer-col footer-right">
        <p class="footer-heading">Contributors</p>
        <div class="contributors">
          <span class="contributor">Rahul</span>
          <span class="contributor">Nikunj</span>
          <span class="contributor">Neel</span>
          <span class="contributor">Dhvanil</span>
          <span class="contributor">Mansi</span>
          <span class="contributor">Darshit</span>
        </div>
      </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.expand", "navigation.instant", "toc.integrate", "content.code.copy", "navigation.footer"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>